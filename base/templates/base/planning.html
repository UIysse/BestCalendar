{% extends 'main.html' %}
{% load form_tags %}
{% load static %}
{% load custom_filters %}
{% block content %}
{% if user.is_authenticated %}
{% if perms.members.custom_permission %}
<div style="display: flex; justify-content: space-between; align-items: center;">
    {{ start_date|add_days:3|date:'Y' }}, Semaine {{ start_date|date:'W' }}
    <div>
        <a class="bi bi-arrow-left-circle" style="font-size: 1.2em;" href="{% url 'planning_with_params' year=prev_year week=prev_week %}"></a>
        <input type="date" id="datePicker" name="date" value="{{ start_date|date:'Y-m-d' }}">
        <a class="bi bi-arrow-right-circle" style="font-size: 1.2em;" href="{% url 'planning_with_params' year=next_year week=next_week %}"></a>
    </div>
    <div>
        <i class="bi bi-copy icon-overlay" style="font-size: 1.5em; padding-right: 5px; padding-left: 5px;" title="Copier des shifts" onclick = "CopyShifts()"></i>
        <i class="bi bi-trash icon-overlay" style="font-size: 1.5em; padding-right: 5px; padding-left: 5px;" title="Supprimer des shifts" onclick = "DeleteShifts()"></i>
        <i class="bi bi-printer icon-overlay" style="font-size: 1.5em; padding-right: 5px; padding-left: 5px;" title="Imprimer le planning" onclick="printTable()"></i>
    </div>
</div>
<table class = "my-table", border="1" id = "table1">
    <thead>
        <tr>
            <th></th>
            {% for day in days %}
                <th>{{ day|date:'D, d' }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for emp in employe %}
            <tr>
                <td class ="employee-cell">
                {{ emp.firstname }} {{ emp.name }}
                </td>
                {% for day in days %}
                    <!-- Shift code here -->
                                <td class ="outter-cell" 
                                style = "font-size: 16px;" 
                                ondragover="allowDrop(event)" 
                                ondrop="dropShift(event); resetDropEffects(event);"
                                ondragleave="dragLeave(event)"
                                onclick="openModal(this, '{{ emp.id }}', '{{ emp.name }}', '{{ emp.firstname }}', '{{ emp.Poste.id }}', '{{ day|date:'Y-m-d' }}')"
                                data-EmployeId = "{{ emp.id }}"
                                data-date = "{{ day|date:'Y-m-d' }}">
                                    <i class="bi bi-plus-circle-fill plus-icon"></i>
                                    <table border="1">
                                        {% for key, value in shifts_by_emp_and_day.items %}
                                            {% if emp.id == key %}<!-- test sur employe match-->
                                                {% for key1, value1 in value.items %}
                                                    {% if day == key1 %} <!-- test sur day match-->
                                                        {% for nitem in value1 %}
                                                            <tr style="background-color: {% if nitem.is_overtime %}red{% elif nitem.is_absence%}lightgray{% else %}{{ nitem.Poste.couleur }}{% endif %};"><!-- si heure sup couleur rouge autrement couleur du poste-->
                                                                <td class="shift-cell {% if nitem.is_unscheduled %}unscheduled-shift{% endif %}"
                                                                    draggable="true"
                                                                    ondragstart="dragStart(event)" 
                                                                    ondragover="allowDrop(event)"
                                                                    onclick="openInnerModal(event, this)"
                                                                    data-date = "{{ day|date:'Y-m-d' }}"
                                                                    data-Heureded√©but="{{ nitem.Heureded√©but }}"
                                                                    data-heuredefin="{{ nitem.heuredefin }}"
                                                                    data-end-time="{{ nitem.heuredefin }}"
                                                                    data-duree-pause="{{ nitem.dur√©epause }}"
                                                                    data-Poste="{{ nitem.Poste.id }}"
                                                                    data-note="{{ nitem.note }}"
                                                                    data-EmployeName = "{{ emp.name }}"
                                                                    data-EmployeFirstName = "{{ emp.firstname }}"
                                                                    data-EmployeId = "{{ emp.id }}"
                                                                    data-shiftId = "{{ nitem.id }}"
                                                                    data-bs-toggle="tooltip"
                                                                    data-bs-html="true"
                                                                    data-bs-placement="top"
                                                                    title=" 
                                                                        {% if nitem.is_unscheduled %} 
                                                                        ‚ö†Ô∏è Shift non pr√©vu<br>
                                                                        {%endif%}
                                                                        {% if nitem.note %} 
                                                                        Note : {{ nitem.note }}<br>
                                                                        {%endif%}
                                                                        {% if nitem.users_badged_shift %}
                                                                            üìå <b>Badges :</b> <br>
                                                                            {% for arrivee, depart in nitem.users_badged_shift.heures_arrivees|zip_lists:nitem.users_badged_shift.heures_departs %}
                                                                                üîπ {{ arrivee }} - {{ depart|default:'‚ùì' }} <br>
                                                                            {% endfor %}
                                                                            {% if nitem.users_badged_shift.heures_arrivees|length > nitem.users_badged_shift.heures_departs|length %}
                                                                                üîπ {{ nitem.users_badged_shift.heures_arrivees|last }} - ‚ùì <br>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            ‚ùå Aucun badge enregistr√©
                                                                        {% endif %}
                                                                    ">
                                                                    {{nitem.Heureded√©but}} - {{nitem.heuredefin}}      ({{ nitem.duree_pause_minutes }} min) <span class="value-right {% if nitem.users_badged_shift and nitem.difference_travail_reel_theorique|first == '-' %} negative-diff {% elif nitem.users_badged_shift %} positive-diff {% endif %}">{% if nitem.users_badged_shift %}{{nitem.difference_travail_reel_theorique}}{% endif %}</span>
                                                                    {% if nitem.note %}
                                                                        <i class="bi bi-file-text"></i>
                                                                    {% endif %}
                                                                    {% if nitem.is_absence %}
                                                                          - {{nitem.TypeAbsence}}
                                                                    {% endif %}
                                                                    <div class ="PosteCss" style="width: 80%; height: 20px; background-color: {{ nitem.Poste.couleur }}; overflow: hidden; text-overflow: ellipsis ;">{{nitem.Poste}}</div>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    </table>
                                </td>
                    <!-- End of shift code here-->
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>
<!-- The Modal which handles single shifts stuff -->
<div id="myModal" class="modal">
    <div class="modal-dialog" role="document">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <div class="justify-content-end d-flex w-100">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                    </button>
                </div>
            </div>
            <div>
                <ul class="pagination">
                    <li class="page-item active">
                    <a class="page-link" href="#" data-modal-content="nouveauShiftContent">Nouveau shift</a>
                    </li>
                    <li class="page-item">
                    <a class="page-link" href="#" data-modal-content="nouvelAbsenceContent">Nouvelle absence</a>
                    </li>
                    <li class="page-item">
                    <a class="page-link" href="#" data-modal-content="EditerShiftContent">Editer le shift s√©lectionn√©</a>
                    </li>
                </ul>
            </div>
            <!-- Content for New shift -->
            <div id="nouveauShiftContent">
                <h5 class="modal-title">Nouveau shift</h5>
                <form method="post" action="" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- Date -->
                    <div class="form-group row">
                        <label for="{{ form.date.id_for_label }}" class="col-sm-2 col-form-label">{{ form.date.label }}</label>
                        <div class="col-sm-10">
                            {{ form.date|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.date.errors }}</div>
                        </div>
                    </div>
                    <!-- Heure D√©but -->
                    <div class="form-group row">
                        <label for="{{ form.Heureded√©but.id_for_label }}" class="col-sm-2 col-form-label">{{ form.Heureded√©but.label }}</label>
                        <div class="col-sm-10">
                            {{ form.Heureded√©but|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.Heureded√©but.errors }}</div>
                        </div>
                    </div>

                    <!-- Heure Fin -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.heuredefin.label }}</label>
                        <div class="col-sm-10">
                            {{ form.heuredefin|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.heuredefin.errors }}</div>
                        </div>
                    </div>

                    <!-- Pause -->
                    <div class="form-group row">
                        <label for="{{ form.dur√©epause.id_for_label }}" class="col-sm-2 col-form-label">{{ form.dur√©epause.label }}</label>
                        <div class="col-sm-10">
                            {{ form.dur√©epause|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.dur√©epause.errors }}</div>
                        </div>
                    </div>
                    <!-- Employe as a hidden field -->
                    <input type="hidden" name="Employe" id="id_Employe">
                    <!-- Poste -->
                    <div class="form-group row">
                        <label for="{{ form.Poste.id_for_label }}" class="col-sm-2 col-form-label">{{ form.Poste.label }}</label>
                        <div class="col-sm-10">
                            <select name="{{ form.Poste.name }}" id="NewShiftPoste" class="form-select" value="{{ form.Poste.value|default_if_none:'' }}">
                                {% for poste in form.Poste.field.queryset %}
                                    <option value="{{ poste.id }}">
                                        {{ poste.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                <!-- option heure sup -->
                <div class="form-group row">
                    <label for="{{ form.checkbox_field_heuresup.id_for_label }}" class="col-sm-9 col-form-label">
                        {{ form.checkbox_field_heuresup.label }}
                    </label>
                    <div class="col-sm-3 d-flex align-items-start">
                        <input type="checkbox" name="{{ form.checkbox_field_heuresup.name }}" 
                               id="HeureSupCheckbox" 
                               class="form-check-input"
                               style="margin-top: 18px;" 
                               {% if form.checkbox_field_heuresup.value %}checked{% endif %}>
                        <div class="invalid-feedback">{{ form.checkbox_field_heuresup.errors }}</div>
                    </div>
                </div>
                    <!-- Note -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.note.label }}</label>
                        <div class="col-sm-10">
                            {{ form.note|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.note.errors }}</div>
                        </div>
                    </div>
                    <!-- Hidden Form type field -->
                    <div class="form-group row" style="display:none;">
                        <input type="hidden" name="{{ form.action.name }}" id="NouveauShiftTypeFormId">
                    </div>
                    <!-- Bouton Valider -->
                    <div class="modal-footer justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Valider</button>
                    </div>
                </form>
            </div>
            <!-- Content for Nouvelle absence -->
            <div id="nouvelAbsenceContent" style="display: none;">
                <h5 class="modal-title">Nouvelle absence pour</h5>
                <form method="post" action="" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- TypeAbsence -->
                    <div class="form-group">
                        <label for="{{ form.TypeAbsence.id_for_label }}">{{ form.TypeAbsence.label }}</label>
                        {{ form.TypeAbsence }}
                        {% if form.TypeAbsence.errors %}
                            <div class="invalid-feedback">
                                {{ form.TypeAbsence.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Date debut absence -->
                    <div class="form-group row">
                        <label for="{{ form.date.id_for_label }}" class="col-sm-2 col-form-label">{{ form.date.label }}</label>
                        <div class="col-sm-10">
                            <input type="date" name="{{ form.date.name }}" id="NewAbsenceStartDate" class="form-control" value="{{ form.date.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.date.errors }}</div>
                        </div>
                    </div>
                    <!-- Date fin -->
                    <div class="form-group row">
                        <label for="{{ form.second_date.id_for_label }}" class="col-sm-2 col-form-label">{{ form.second_date.label }}</label>
                        <div class="col-sm-10">
                            <input type="date" name="{{ form.second_date.name }}" id="NewAbsenceEndDate" class="form-control" value="{{ form.second_date.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.second_date.errors }}</div>
                        </div>
                    </div>
                    <!-- D√©but -->
                    <div class="form-group row">
                        <label for="{{ form.Heureded√©but.id_for_label }}" class="col-sm-2 col-form-label">{{ form.Heureded√©but.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.Heureded√©but.name }}" id="NouvelleAbsenceHeureded√©but" class="form-control" value="{{ form.Heureded√©but.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.Heureded√©but.errors }}</div>
                        </div>
                    </div>

                    <!-- Fin -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.heuredefin.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.heuredefin.name }}" id="NouvelleAbsenceheuredefin" class="form-control" value="{{ form.heuredefin.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.heuredefin.errors }}</div>
                        </div>
                    </div>

                    <!-- Pause -->
                    <div class="form-group row">
                        <label for="{{ form.dur√©epause.id_for_label }}" class="col-sm-2 col-form-label">{{ form.dur√©epause.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.dur√©epause.name }}" id="NouvelleAbsencedur√©epause" class="form-control" value="{{ form.dur√©epause.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.dur√©epause.errors }}</div>
                        </div>
                    </div>
                    <!-- Employe as a hidden field -->
                    <input type="hidden" name="Employe" id="id_Employe_absent">
                    <!-- Poste -->
                    <input type="hidden" name="Poste" id="id_Poste_absent">
                    <!-- option suppression des shifts -->
                    <div class="form-group row">
                        <label for="{{ form.checkbox_field.id_for_label }}" class="col-sm-9 col-form-label">
                            {{ form.checkbox_field.label }}
                        </label>
                        <div class="col-sm-3 d-flex align-items-start">
                            <input type="checkbox" name="{{ form.checkbox_field.name }}" 
                                id="NewAbsenceCheckbox" 
                                class="form-check-input"
                                style="margin-top: 18px;" 
                                {% if form.checkbox_field.value %}checked{% endif %}>
                            <div class="invalid-feedback">{{ form.checkbox_field.errors }}</div>
                        </div>
                    </div>
                    <!-- Note -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.note.label }}</label>
                        <div class="col-sm-10">
                            {{ form.note|add_class:'form-control' }}
                            <div class="invalid-feedback">{{ form.note.errors }}</div>
                        </div>
                    </div>
                    <!-- Hidden Form type field -->
                    <div class="form-group row" style="display:none;">
                        <input type="hidden" name="{{ form.action.name }}" id="NouvelleAbsenceTypeFormId">
                    </div>
                    <!-- Bouton Valider -->
                    <div class="modal-footer justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Valider</button>
                    </div>
                </form>
            </div>
            <!-- Content for edit shift en utilisant shift id-->
            <div id="EditerShiftContent" style="display: none;">
               <h5 class="modal-title">Modifier le shift</h5>
                <form method="post" action="" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- Date -->
                    <div class="form-group row">
                        <label for="{{ form.date.id_for_label }}" class="col-sm-2 col-form-label">{{ form.date.label }}</label>
                        <div class="col-sm-10">
                            <input type="date" name="{{ form.date.name }}" id="EditShiftDate" class="form-control" value="{{ form.date.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.date.errors }}</div>
                        </div>
                    </div>
                    <!-- D√©but -->
                    <div class="form-group row">
                        <label for="{{ form.Heureded√©but.id_for_label }}" class="col-sm-2 col-form-label">{{ form.Heureded√©but.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.Heureded√©but.name }}" id="EditShiftHeureded√©but" class="form-control" value="{{ form.Heureded√©but.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.Heureded√©but.errors }}</div>
                        </div>
                    </div>

                    <!-- Fin -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.heuredefin.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.heuredefin.name }}" id="EditShiftheuredefin" class="form-control" value="{{ form.heuredefin.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.heuredefin.errors }}</div>
                        </div>
                    </div>

                    <!-- Pause -->
                    <div class="form-group row">
                        <label for="{{ form.dur√©epause.id_for_label }}" class="col-sm-2 col-form-label">{{ form.dur√©epause.label }}</label>
                        <div class="col-sm-10">
                            <input type="time" name="{{ form.dur√©epause.name }}" id="EditShiftdur√©epause" class="form-control" value="{{ form.dur√©epause.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.dur√©epause.errors }}</div>
                        </div>
                    </div>
                    <!-- Employe as a hidden field -->
                    <input type="hidden" name="Employe" id="EditShitid_Employe">
                    <!-- Poste -->
                    <div class="form-group row">
                        <label for="{{ form.Poste.id_for_label }}" class="col-sm-2 col-form-label">{{ form.Poste.label }}</label>
                        <div class="col-sm-10">
                            <select name="{{ form.Poste.name }}" id="EditShiftPoste" class="form-select" value="{{ form.Poste.value|default_if_none:'' }}">
                                {% for poste in form.Poste.field.queryset %}
                                    <option value="{{ poste.id }}">
                                        {{ poste.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!-- Note -->
                    <div class="form-group row">
                        <label for="{{ form.heuredefin.id_for_label }}" class="col-sm-2 col-form-label">{{ form.note.label }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="{{ form.note.name }}" id="EditShiftnote" class="form-control" value="{{ form.note.value|default_if_none:'' }}">
                            <div class="invalid-feedback">{{ form.note.errors }}</div>
                        </div>
                    </div>
                    <!-- Hidden Form type field -->
                    <div class="form-group row" style="display:none;">
                        <input type="hidden" name="{{ form.action.name }}" id="EditShiftTypeFormId">
                    </div>
                    <!-- Hidden shiftId field -->
                    <div class="form-group row" style="display:none;">
                        <input type="hidden" name="{{ form.shift_Id.name }}" id="EditShiftShift_Id">
                    </div>
                    <!-- Bouton Valider -->
                    <div class="modal-footer justify-content-end">
                        <button type="submit" name="actionButton" value="delete" class="btn btn-danger">Supprimer</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal ">Annuler</button>
                        <button type="submit" name="actionButton" value="edit" class="btn btn-primary">Valider</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- The Drag copier deplacer form-->
<form id="shiftForm" method="POST" action="{% url 'update_shift' %}">
    {% csrf_token %}
    <input type="hidden" name="shift_id" id="shiftIdInput">
    <input type="hidden" name="new_employe_id" id="newEmployeIdInput">
    <input type="hidden" name="new_poste" id="newPosteInput">
    <input type="hidden" name="new_date" id="newDateInput">
    <input type="hidden" name="new_start_time" id="newStartTimeInput">
    <input type="hidden" name="new_end_time" id="newEndTimeInput">
    <input type="hidden" name="new_pause_duration" id="newPauseDurationInput">
    <input type="hidden" name="new_note" id="newNoteInput">
    <input type="hidden" name="actionButton" id="actionButtonInput">
</form>
<!-- The Modal which copies shifts -->
<div id="ModalCopy" class="modal">
    <div class="modal-dialog" role="document">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <div class="justify-content-end d-flex w-100">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                    </button>
                </div>
            </div>
            <!-- Body of modal -->
            <div id="CopyShiftContent">
                <h5 class="modal-title">Copiez des shifts</h5>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="employee-list" style="max-height: 30vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc;">
                    {% for emp in employe %}
                        <input type="checkbox" name="employe_{{ emp.id }}" id="employe_{{ emp.id }}"/>
                        <span>{{ emp.name }} {{ emp.firstname }}</span>  <!-- Assuming your Employee model has a 'name' field -->
                        </label><br>
                    {% endfor %}
                </div>
                <h5 class="modal-title">S√©lectionnez les semaines concern√©es</h5>
                <div style="max-height: 30vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc;">
                    <table class="table table-hover" id="selectableTable">
                    <tbody>
                        {% for oneweekinside in weeks %}
                            <tr id="week_{{ oneweekinside.week_number }}" >
                            <td> S{{ oneweekinside.week_number }}, {{ oneweekinside.first_day|date:"l d F" }}</td>  <!-- Assuming your Employee model has a 'name' field -->
                            </tr>
                        {% endfor %}
                        <!-- Add more rows as needed -->
                    </tbody>
                    </table>
                </div>
                <h6 class="modal-title">S√©lectionnez les jours concern√©s</h6>
                <div style="text-align: center;">
                    <input type="checkbox" class="btn-check" id="btn-check-Lundi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Lundi">Lu</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Mardi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Mardi">Ma</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Mercredi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Mercredi">Me</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Jeudi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Jeudi">Je</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Vendredi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Vendredi">Ve</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Samedi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Samedi">Sa</label>
                    <input type="checkbox" class="btn-check" id="btn-check-Dimanche" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-Dimanche">Di</label>
                </div>
                {{ selectionform }}
                <!-- Bouton Valider -->
                <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" name="actionButton" value="ValidateCopyMultipleShifts" id="modalSubmitBtn" class="btn btn-primary">Valider</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- The Modal which deletes shifts -->
<div id="ModalDelete" class="modal">
    <div class="modal-dialog" role="document">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <div class="justify-content-end d-flex w-100">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                    </button>
                </div>
            </div>
            <!-- Body of modal -->
            <div id="DeleteShiftContent">
                <h5 class="modal-title">Supprimez plusieurs shifts</h5>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="employee-list-delete-shifts" style="max-height: 30vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc;">
                    {% for emp in employe %}
                        <input type="checkbox" name="employe_{{ emp.id }}" id="employe_{{ emp.id }}"/>
                        <span>{{ emp.name }} {{ emp.firstname }}</span>  <!-- Assuming your Employee model has a 'name' field -->
                        </label><br>
                    {% endfor %}
                </div>
                <h5 class="modal-title">S√©lectionnez les semaines concern√©es</h5>
                <div style="max-height: 30vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc;">
                    <table class="table table-hover" id="selectableTable">
                    <tbody>
                        {% for oneweekinside in weeks %}
                            <tr id="week_{{ oneweekinside.week_number }}" >
                            <td> S{{ oneweekinside.week_number }}, {{ oneweekinside.first_day|date:"l d F" }}</td>  <!-- Assuming your Employee model has a 'name' field -->
                            </tr>
                        {% endfor %}
                        <!-- Add more rows as needed -->
                    </tbody>
                    </table>
                </div>
                <h6 class="modal-title">S√©lectionnez les jours concern√©s</h6>
                <div style="text-align: center;">
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Lundi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Lundi">Lu</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Mardi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Mardi">Ma</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Mercredi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Mercredi">Me</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Jeudi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Jeudi">Je</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Vendredi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Vendredi">Ve</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Samedi" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Samedi">Sa</label>
                    <input type="checkbox" class="btn-check" id="btn-check-delete-Dimanche" autocomplete="off">
                    <label class="btn btn-outline-primary" for="btn-check-delete-Dimanche">Di</label>
                </div>
                {{ selectionform }}
                <!-- Bouton Valider -->
                <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" name="actionButton" value="ValidateDeleteMultipleShifts" id="modalDeleteShiftsSubmitBtn" class="btn btn-primary">Valider</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script> 
    function printTable() {
        var tableContent = document.getElementById("table1").outerHTML;
        var newWin = window.open('', '_blank');
        newWin.document.open();
        newWin.document.write('<html><body onload="window.print()">' + tableContent + '</body></html>');
        newWin.document.close();
        setTimeout(function(){newWin.close();}, 10);
    }
    var modalCopy = document.getElementById("ModalCopy"); //move this into the function ?
    var modalDelete = document.getElementById("ModalDelete"); //move this into the function ?
    function CopyShifts(){
        console.log("copy")
        modalCopy.querySelector('.modal-title').textContent = 'Copiez plusieurs shifts de la semaine en cours';
        modalCopy.style.display = "block";
        document.getElementById('CopyShiftContent').style.display = 'block';
    }
    function DeleteShifts(){
        console.log("delete")
        modalDelete.querySelector('.modal-title').textContent = 'Supprimez plusieurs shifts';
        modalDelete.style.display = "block";
        document.getElementById('DeleteShiftContent').style.display = 'block';
    }
    function convertTo24HourFormat(timeString) {
        let [time, modifier] = timeString.split(' ');
        let [hours, minutes] = time.split(':');

        // Set default minutes if missing
        minutes = minutes || '00';

        // Convert hours to integer and pad with zero if needed
        hours = parseInt(hours, 10);
        if (hours === 12 && modifier === 'a.m.') {
            hours = 0; // 12 a.m. is 00:00 in 24-hour format
        } else if (modifier === 'p.m.' && hours !== 12) {
            hours += 12; // For PM hours, except for 12 p.m. (noon)
        }
        hours = hours.toString().padStart(2, '0');

        return `${hours}:${minutes}`;
    }
    // Code qui gere la modal
    // Get the modal
    var modal = document.getElementById("myModal"); //move this into the function ?
    
    // Function to open the modal that defaults to a New Shift
    function openModal(td, empId, empName, empFirstName, empPoste, date) {
        //modal.querySelector('[name="Employe"]').value = empId;
        modal.querySelector('[name="date"]').value = date;
        modal.querySelector('#id_Employe').value = empId;
        modal.querySelector('#id_Employe_absent').value = empId;
        var posteField = document.getElementById('NewShiftPoste');
        console.log('Modal State:', modal.style.display);
        console.log('Poste Field:', posteField);
        console.log('Dropdown Options:', Array.from(posteField.options).map(option => ({
            value: option.value,
            text: option.text
        })));
        if (posteField) {
            // Log dropdown options for debugging

            // Set the dropdown value directly
            posteField.value = empPoste;
            modal.querySelector('#id_Poste_absent').value = empPoste;
            // Log the updated value
            //console.log('Set Poste field value to:', posteField.value);
        } else {
            console.error('Poste dropdown (EditShiftPoste) not found.');
        }
        document.getElementById('NouveauShiftTypeFormId').value = "AddShift";
        document.getElementById('NouvelleAbsenceTypeFormId').value = "NouvelleAbsence";
        // Update the modal title
        modal.querySelector('.modal-title').textContent = 'Nouveau shift pour ' + empName + ' ' + empFirstName;
        modal.style.display = "block";
        //make contenu de nouveau shift displayed
        document.getElementById('nouveauShiftContent').style.display = 'none';
        document.getElementById('nouvelAbsenceContent').style.display = 'none';
        document.getElementById('EditerShiftContent').style.display = 'none';
        document.getElementById('nouveauShiftContent').style.display = 'block';
        //make nouveau shift page active only
        var paginationItems = document.querySelectorAll('.pagination .page-item');
        
        // Remove 'active' class from all pagination items
        paginationItems.forEach(function(item) {
            item.classList.remove('active');
        });

        // Add 'active' class to the third pagination item
        // Note: Array indices are zero-based, so the third item is at index 2
        paginationItems[0].classList.add('active');
        // Disable the third pagination item
        paginationItems[2].classList.add('disabled');
        }

    //function to open the modal that defaults to edit shift
    function openInnerModal(event, cell) {
        // Stop the event from propagating to the outer table cell
        console.log("Inner modal function called");
        event.stopPropagation();
        // Retrieve data from the cell's data attributes
        var startTime = cell.getAttribute('data-start-time');
        var endTime = cell.getAttribute('data-end-time');
        var note = cell.getAttribute('data-note');
        modal.querySelector('.modal-title').textContent = 'Modifier le shift de ';
        modal.style.display = "block";
        document.getElementById('nouveauShiftContent').style.display = 'none';
        document.getElementById('nouvelAbsenceContent').style.display = 'none';
        document.getElementById('EditerShiftContent').style.display = 'none';
        //Fill Edit shift form
        document.getElementById('EditShiftDate').value = cell.getAttribute('data-date');
        document.getElementById('EditShiftHeureded√©but').value = convertTo24HourFormat(cell.getAttribute('data-Heureded√©but'));
        document.getElementById('EditShiftheuredefin').value = convertTo24HourFormat(cell.getAttribute('data-end-time'));
        document.getElementById('EditShiftdur√©epause').value = convertTo24HourFormat(cell.getAttribute('data-duree-pause'));
        document.getElementById('EditShitid_Employe').value = cell.getAttribute('data-EmployeId');
        document.getElementById('EditShiftTypeFormId').value = "EditShift";
        document.getElementById('EditShiftShift_Id').value = cell.getAttribute('data-shiftId');
        document.getElementById('EditShiftPoste').value = cell.getAttribute('data-Poste');
        document.getElementById('EditShiftnote').value = cell.getAttribute('data-note');
        document.getElementById('EditerShiftContent').style.display = 'block';
        //Fill nouveau shift form
        modal.querySelector('[name="date"]').value = cell.getAttribute('data-date');
        modal.querySelector('#id_Employe').value = cell.getAttribute('data-EmployeId');
        document.getElementById('NouveauShiftTypeFormId').value = "AddShift";
        //Fill nouvelle absence form
        document.getElementById('NouvelleAbsenceTypeFormId').value = "NouvelleAbsence";
        modal.querySelector('#id_Employe_absent').value = cell.getAttribute('data-EmployeId');
        modal.querySelector('#id_Poste_absent').value = cell.getAttribute('data-Poste');
        //make edition page active only
        var paginationItems = document.querySelectorAll('.pagination .page-item');
        
        // Remove 'active' class from all pagination items
        paginationItems.forEach(function(item) {
            item.classList.remove('active');
        });
        //enable the last pagination
        paginationItems[2].classList.remove('disabled');

        // Add 'active' class to the third pagination item
        // Note: Array indices are zero-based, so the third item is at index 2
        if (paginationItems.length > 2) {
            paginationItems[2].classList.add('active');
        }
    }
    //Makes sure clicking (X) will close the right modal
    document.querySelectorAll('.btn-close').forEach(function(btn) {
        btn.onclick = function() {
            // Directly close the parent modal of the clicked button
            this.closest('.modal').style.display = "none";
        }
    });
    //close on all annuler boutons
    var cancelButtons = document.getElementsByClassName("btn btn-secondary");

    Array.from(cancelButtons).forEach(function(cancelButton) {
        cancelButton.onclick = function() {
            modal.style.display = "none";
        };
    });
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
    if (event.target == modalCopy) {
        modalCopy.style.display = "none";
    } else if (event.target == modalDelete) {
        modalDelete.style.display = "none";
    } else if (event.target == modal) {
        modal.style.display = "none";
    }
    // Add similar conditions for other modals
}
//manages user clicks on datepicker date
document.getElementById('datePicker').addEventListener('change', function() {
        const selectedDate = this.value;

        if (selectedDate) {
            // Redirect to the URL with the selected date as a GET parameter
            window.location.href = `{% url 'planning' %}?date=${selectedDate}`;
        }
    });
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('#selectableTable tr');
  
  // Start loop from 1 to skip the first row (typically the header)
  rows.forEach((row, index) => {
    row.addEventListener('click', () => {
      // Toggle 'table-active' class on the clicked row
      row.classList.toggle('table-primary');
    });
  });
});
//manage the submit of copyshiftsmodal
document.getElementById('modalSubmitBtn').addEventListener('click', function() {
    // Find all checked checkboxes within the employee list
    var checkedCheckboxes = document.querySelectorAll('.employee-list input[type="checkbox"]:checked');
    
    // Map over each checkbox to extract the ID part of the `id` attribute
    var selectedEmployeeIds = Array.from(checkedCheckboxes).map(function(checkbox) {
        // Assuming the id is in the format "employe_ID"
        return checkbox.id.replace('employe_', '');
    });

    // Now, selectedEmployeeIds contains all the IDs of the checked employees
    console.log(selectedEmployeeIds); // For demonstration, log the IDs to the console
    //rows
    var selectedRows = document.querySelectorAll('#ModalCopy .table.table-hover tbody tr.table-primary');
        // Extract the week_number from the row IDs, assuming IDs are in the format 'week_X'
        var selectedWeekIds = Array.from(selectedRows).map(function(row) {
            return row.id.replace('week_', '');
        });

        // Now, selectedWeekIds contains the IDs of all selected (primary) weeks
        console.log(selectedWeekIds); // For demonstration purposes
        // Select all checked checkboxes within the modal
    var checkedButtons = document.querySelectorAll('#ModalCopy .btn-check:checked');
    
    // Initialize an array to hold the ids of checked checkboxes
    var activeDays = [];
    
    // Iterate over each checked checkbox and extract its id
    checkedButtons.forEach(function(checkbox) {
        activeDays.push(checkbox.id.replace('btn-check-', '')); // Removes the prefix to get the day
    });
    

    // Populate the hidden form fields with these values
    modalCopy.querySelector('input[name="employees"]').value = selectedEmployeeIds.join(',');
    modalCopy.querySelector('input[name="weeks"]').value = selectedWeekIds.join(',');
    modalCopy.querySelector('input[name="days"]').value = activeDays.join(',');
    modalCopy.querySelector('input[name="year_to_copy_from"]').value = "{{ start_date|date:'Y' }}";
});
//manage the submit of deleteshiftmodal
document.getElementById('modalDeleteShiftsSubmitBtn').addEventListener('click', function() {
    // Find all checked checkboxes within the employee list
    var checkedCheckboxes = document.querySelectorAll('.employee-list-delete-shifts input[type="checkbox"]:checked');
    
    // Map over each checkbox to extract the ID part of the `id` attribute
    var selectedEmployeeIds = Array.from(checkedCheckboxes).map(function(checkbox) {
        // Assuming the id is in the format "employe_ID"
        return checkbox.id.replace('employe_', '');
    });

    // Now, selectedEmployeeIds contains all the IDs of the checked employees
    console.log(selectedEmployeeIds); // For demonstration, log the IDs to the console
    //rows
    var selectedRows = document.querySelectorAll('#ModalDelete .table.table-hover tbody tr.table-primary');
        // Extract the week_number from the row IDs, assuming IDs are in the format 'week_X'
        var selectedWeekIds = Array.from(selectedRows).map(function(row) {
            return row.id.replace('week_', '');
        });

        // Now, selectedWeekIds contains the IDs of all selected (primary) weeks
        console.log(selectedWeekIds); // For demonstration purposes
        // Select all checked checkboxes within the modal
    var checkedButtons = document.querySelectorAll('#ModalDelete .btn-check:checked');
    
    // Initialize an array to hold the ids of checked checkboxes
    var activeDays = [];
    
    // Iterate over each checked checkbox and extract its id
    checkedButtons.forEach(function(checkbox) {
        activeDays.push(checkbox.id.replace('btn-check-delete-', '')); // Removes the prefix to get the day
    });
    
    // Now, activeDays contains the list of ids (days) of all active buttons
    console.log(activeDays); // For demonstration, log the active days to the console

    // Populate the hidden form fields with these values
    modalDelete.querySelector('input[name="employees"]').value = selectedEmployeeIds.join(',');
    modalDelete.querySelector('input[name="weeks"]').value = selectedWeekIds.join(',');
    modalDelete.querySelector('input[name="days"]').value = activeDays.join(',');
    modalDelete.querySelector('input[name="year_to_copy_from"]').value = "{{ start_date|date:'Y' }}";
});
</script>
<script> // code qui gere le contenu modal displayed √† partir d'un click de pagination
    document.querySelectorAll('.pagination .page-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove 'active' class from all pagination items
            document.querySelectorAll('.pagination .page-item').forEach(function(item) {
                item.classList.remove('active');
            });

            // Add 'active' class to the clicked pagination item's parent
            this.parentNode.classList.add('active');

            // Hide both content sections
            document.getElementById('nouveauShiftContent').style.display = 'none';
            document.getElementById('nouvelAbsenceContent').style.display = 'none';
            document.getElementById('EditerShiftContent').style.display = 'none';

            // Get the ID of the content section to show
            var contentToShow = this.getAttribute('data-modal-content');

            // Show the selected content section
            document.getElementById(contentToShow).style.display = 'block';
        });
    });
</script>
<!-- Le script qui g√®re l'affichage du tooltip suit cette ligne -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    let draggedShift = null; // Stocke la cellule source

    function dragStart(event) {
        draggedShift = event.target; 
        let targetCell = event.target.closest(".shift-cell");
        if (targetCell) {
            event.dataTransfer.effectAllowed = "move";
            event.dataTransfer.setData("text/plain", event.target.dataset.shiftId); // Stocke l'ID
            targetCell.setAttribute("data-original-text", targetCell.textContent); // Sauvegarde du texte original
            // üìå Cr√©er un √©l√©ment fant√¥me (ghost) personnalis√©
            let dragGhost = targetCell.cloneNode(true); // Clone la cellule
            dragGhost.style.position = "absolute";
            dragGhost.style.top = "-9999px"; // On le place hors de l'√©cran pour qu'il ne soit pas visible dans le DOM
            dragGhost.style.opacity = "0.2"; // üî• R√©duction de l'opacit√©
            dragGhost.style.background = "rgba(255, 255, 255, 0.2)"; // Optionnel : fond semi-transparent
            dragGhost.style.padding = "5px"; // Ajuster l'espacement pour une meilleure apparence
            dragGhost.style.borderRadius = "8px"; // Ajouter un arrondi
            dragGhost.style.boxShadow = "0px 4px 6px rgba(0,0,0,0.2)"; // Ombre pour un effet plus visuel

            document.body.appendChild(dragGhost); // Ajoute le ghost temporaire au document
            event.dataTransfer.setDragImage(dragGhost, 0, 0); // üìå D√©finit le ghost personnalis√© comme image de drag

            setTimeout(() => {
                document.body.removeChild(dragGhost); // Supprime apr√®s le drag
            }, 0);
        }
    }

    function allowDrop(event) {
        event.preventDefault();
        let targetCell = event.target.closest("td");
        
        // üö´ Forcer l'affichage de l'ic√¥ne interdit sur shift-cell
        if (targetCell && targetCell.classList.contains("shift-cell")) {
            event.stopPropagation(); // Emp√™che la propagation vers outter-cell
            return; // Ne fait pas event.preventDefault() ‚Üí Le navigateur affiche üö´
        }
        if (targetCell) {
            let rect = targetCell.getBoundingClientRect(); // R√©cup√©rer les dimensions de la cellule
            let mouseX = event.clientX - rect.left; // Position de la souris relative √† la cellule
            let halfWidth = rect.width / 2; // Moiti√© de la largeur

            // Supprimer toutes les classes d'animation pour √©viter l'accumulation
            targetCell.classList.remove("left-drop", "right-drop", "valid-drop", "invalid-drop");


            if (targetCell.classList.contains("outter-cell")) {
                if (mouseX < halfWidth) {
                    targetCell.classList.add("left-drop"); // Animation sp√©ciale moiti√© gauche üîµ
                } else {
                    targetCell.classList.add("right-drop"); // Animation sp√©ciale moiti√© droite üî¥
                }
            }
        }
    }

    // ‚ùå Enlever les animations quand l'√©l√©ment quitte la cellule
    function dragLeave(event) {
        let targetCell = event.target.closest("td");
        if (targetCell) {
            targetCell.classList.remove("left-drop", "right-drop", "valid-drop", "invalid-drop");
        }
    }


    // üìå G√©rer le drop (Copie des donn√©es + Supprimer les animations)
    function dropShift(event) {
        event.preventDefault();

        let targetCell = event.target.closest("td");
        if (!targetCell || !draggedShift) return;
        if (!targetCell || targetCell.classList.contains("shift-cell")) {
            return; // ‚õî Emp√™che le drop sur les cellules celldata
        }

        // üìå Afficher toutes les donn√©es de la cellule cible
        console.log("üîΩ Donn√©es de la cellule o√π l'on drop :", targetCell.dataset);

        // ‚úÖ Autoriser uniquement le drop sur outter-cell
        if (targetCell.classList.contains("outter-cell")) {
            // ‚úÖ R√©cup√©ration de toutes les donn√©es disponibles
            let shiftId = draggedShift.dataset.shiftid || "undefined";
            let newEmployeId = draggedShift.dataset.employeid || "undefined";
            let employeFirstName = draggedShift.dataset.employefirstname || "undefined";
            let employeName = draggedShift.dataset.employename || "undefined";
            let posteId = draggedShift.dataset.poste || "undefined";
            let startTime = draggedShift.dataset.heureded√©but || "undefined";
            let endTime = draggedShift.dataset.heuredefin || "undefined";
            let pauseDuration = draggedShift.dataset.dureePause || "undefined";
            let note = draggedShift.dataset.note || "undefined";
            let newDate = draggedShift.dataset.date || "undefined";
            
            //data de la cellule cible
            let newDateTarget = targetCell.dataset.date || "undefined";
            let newEmployeIdTarget = targetCell.dataset.employeid || "undefined";

            // üìå V√©rifier toutes les valeurs dans la console
            console.log("üîÑ Mise √† jour du shift avec les donn√©es suivantes :", {
                shift_id: shiftId,
                new_employe_id: newEmployeId,
                employe_firstname: employeFirstName,
                employe_name: employeName,
                poste_id: posteId,
                start_time: startTime,
                end_time: endTime,
                pause_duration: pauseDuration,
                note: note,
                new_date: newDate
            });
            // Fill the hidden form
            document.getElementById("shiftIdInput").value = shiftId;
            document.getElementById("newEmployeIdInput").value = newEmployeIdTarget;
            document.getElementById("newPosteInput").value = posteId;
            document.getElementById("newDateInput").value = newDateTarget;
            document.getElementById("newStartTimeInput").value = startTime;
            document.getElementById("newEndTimeInput").value = endTime;
            document.getElementById("newPauseDurationInput").value = pauseDuration;
            document.getElementById("newNoteInput").value = note;
            document.getElementById("actionButtonInput").value = "copier";
            if (targetCell.classList.contains("left-drop")) {
                document.getElementById("actionButtonInput").value = "deplacer";
            } else if (targetCell.classList.contains("right-drop")) {
                document.getElementById("actionButtonInput").value = "copier";
            }
            // Submit the form automatically
            document.getElementById("shiftForm").submit();
            // üìå Remplir et soumettre le formulaire cach√©
            //document.getElementById("shiftIdInput").value = shiftId;
            //document.getElementById("newEmployeIdInput").value = newEmployeId;
            //document.getElementById("newDateInput").value = newDate;
            //document.getElementById("shiftForm").submit(); // üîÑ Recharge la page apr√®s envoi
        }
    }

    function resetDropEffects(event) {
        let targetCell = document.querySelectorAll(".outter-cell, .shift-cell"); // S√©lectionne toutes les cellules concern√©es
        targetCell.forEach(cell => {
            cell.classList.remove("left-drop", "right-drop", "valid-drop", "invalid-drop");
        });
    }

</script>
<!--<script>
    document.querySelectorAll('.shift-cell').forEach(cell => {
        cell.addEventListener('mouseenter', function () {
            let employeId = this.getAttribute('data-employeId');
            let date = this.getAttribute('data-date');

            fetch(`/api/get-badge-hours/${employeId}/${date}/`)
                .then(response => response.json())
                .then(data => {
                    let tooltipText = (data.status === 'success')
                        ? `Arriv√©es: ${data.heures_arrivees.join(", ")} | D√©parts: ${data.heures_departs.join(", ")}`
                        : "Aucun badge trouv√©";

                    this.setAttribute('data-bs-original-title', tooltipText); // Met √† jour le texte de la tooltip
                    
                    let tooltipInstance = bootstrap.Tooltip.getInstance(this); // V√©rifie si la tooltip existe
                    if (tooltipInstance) {
                        tooltipInstance.dispose(); // Supprime la tooltip existante
                    }
                    
                    bootstrap.Tooltip.getOrCreateInstance(this); // Cr√©e ou met √† jour la tooltip
                })
                .catch(error => {
                    console.error('Erreur AJAX:', error);
                    this.setAttribute('data-bs-original-title', "Erreur de chargement");

                    let tooltipInstance = bootstrap.Tooltip.getInstance(this);
                    if (tooltipInstance) {
                        tooltipInstance.dispose();
                    }

                    bootstrap.Tooltip.getOrCreateInstance(this);
                });
        });
    });

</script>-->
{% else %}
  <!-- Content to be displayed if the user does not have the permission -->
  <p>The user does not have the permission.</p>
{% endif %}
{% else %}
<h1>Veuillez vous connecter pour acc√©der √† cette page web</h1>

<a href="{% url 'login' %}">Se connecter</a>

{% endif %}
{% endblock %}